rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    /** Shared helpers */
    function signedIn() {
      return request.auth != null && request.auth.uid != null;
    }

    function currentUserDoc() {
      return signedIn() ? get(/databases/$(database)/documents/users/$(request.auth.uid)) : null;
    }

    function roleEquals(value, expected) {
      return value is string && lower(value) == lower(expected);
    }

    function isCoach() {
      let doc = currentUserDoc();
      return doc != null && doc.exists() && roleEquals(doc.data.role, 'coach');
    }

    function normalizedList(value) {
      return value is list ? value : [];
    }

    function currentPlayerTeamIds() {
      let doc = currentUserDoc();
      return doc != null && doc.exists()
        ? normalizedList(
            doc.data.teamIds is list && doc.data.teamIds.size() > 0
              ? doc.data.teamIds
              : (doc.data.teams is list ? doc.data.teams : [])
          )
        : [];
    }

    function currentCoachTeamIds() {
      let doc = currentUserDoc();
      if (!(doc != null && doc.exists())) {
        return [];
      }

      let explicit = doc.data.coachTeamIds is list ? doc.data.coachTeamIds : [];
      if (explicit.size() > 0) {
        return explicit;
      }

      return isCoach() ? currentPlayerTeamIds() : [];
    }

    function hasMembership(teamId) {
      return teamId != null && (
        currentPlayerTeamIds().hasAny([teamId]) ||
        currentCoachTeamIds().hasAny([teamId])
      );
    }

    function teamDoc(teamId) {
      return get(/databases/$(database)/documents/teams/$(teamId));
    }

    function isHeadCoach(teamId) {
      let team = teamDoc(teamId);
      return team != null && team.exists() && team.data.coachId == request.auth.uid;
    }

    function coachCanManageTeam(teamId) {
      return isCoach() && hasMembership(teamId);
    }

    function hasField(field) {
      return request.resource.data.keys().hasAny([field]);
    }

    function stringField(field) {
      return hasField(field) && request.resource.data[field] is string && request.resource.data[field].size() > 0;
    }

    function optionalStringField(field) {
      return !hasField(field) || request.resource.data[field] is string;
    }

    function boolField(field) {
      return hasField(field) && request.resource.data[field] is bool;
    }

    function optionalBoolField(field) {
      return !hasField(field) || request.resource.data[field] is bool;
    }

    function numberField(field) {
      return hasField(field) && (request.resource.data[field] is int || request.resource.data[field] is float);
    }

    function optionalNumberField(field) {
      return !hasField(field) || (request.resource.data[field] is int || request.resource.data[field] is float);
    }

    function listField(field) {
      return hasField(field) && request.resource.data[field] is list;
    }

    function stringListField(field) {
      return !hasField(field) || (request.resource.data[field] is list && request.resource.data[field].all(item, item is string));
    }

    function requiredStringList(field) {
      return hasField(field) && request.resource.data[field] is list && request.resource.data[field].size() > 0 &&
        request.resource.data[field].all(item, item is string);
    }

    function roleImmutable() {
      return !hasField('role') || (resource != null && resource.exists() && roleEquals(request.resource.data.role, resource.data.role));
    }

    function preferencesAreMap() {
      return !hasField('preferences') || request.resource.data.preferences is map;
    }

    function membershipListsAreValid() {
      return stringListField('teamIds') && stringListField('coachTeamIds');
    }

    function playerCantGainCoachTeams() {
      return !(resource != null && resource.exists() && roleEquals(resource.data.role, 'player')) ||
        request.resource.data.coachTeamIds == resource.data.coachTeamIds;
    }

    function coachCantAlterPlayerTeams() {
      return !(resource != null && resource.exists() && roleEquals(resource.data.role, 'coach')) ||
        request.resource.data.teamIds == resource.data.teamIds;
    }

    function canSelfUpdateUser() {
      return roleImmutable() && preferencesAreMap() && membershipListsAreValid() && playerCantGainCoachTeams() && coachCantAlterPlayerTeams();
    }

    function coachTeamsRemoved() {
      let before = resource != null && resource.exists() && resource.data.coachTeamIds is list ? resource.data.coachTeamIds : [];
      let after = request.resource.data.coachTeamIds is list ? request.resource.data.coachTeamIds : [];
      return before.filter(teamId => !after.hasAny([teamId]));
    }

    function coachRemovalAllowed() {
      let removed = coachTeamsRemoved();
      return removed.size() > 0 && removed.all(teamId => isHeadCoach(teamId));
    }

    /** Users */
    match /users/{userId} {
      allow read: if signedIn() && (
        request.auth.uid == userId ||
        (isCoach() && roleEquals(resource.data.role, 'player') && resource.data.teamIds is list && resource.data.teamIds.hasAny(currentCoachTeamIds())) ||
        (isCoach() && roleEquals(resource.data.role, 'coach') && resource.data.coachTeamIds is list && resource.data.coachTeamIds.hasAny(currentCoachTeamIds()))
      );

      allow create: if signedIn() && request.auth.uid == userId;

      allow update: if signedIn() && (
        (request.auth.uid == userId && canSelfUpdateUser()) ||
        (isCoach() && roleEquals(resource.data.role, 'coach') && coachRemovalAllowed())
      );
    }

    /** Teams */
    match /teams/{teamId} {
      allow read: if signedIn() && hasMembership(teamId);

      allow create: if signedIn() && isCoach() &&
        stringField('name') &&
        numberField('seasonYear') &&
        stringField('coachId') &&
        request.resource.data.coachId == request.auth.uid &&
        optionalStringField('logoUrl') &&
        optionalStringField('primaryColor') &&
        optionalStringField('joinCodePlayer') &&
        optionalStringField('joinCodeCoach');

      allow update: if signedIn() && coachCanManageTeam(teamId) &&
        optionalStringField('name') &&
        optionalNumberField('seasonYear') &&
        optionalStringField('coachId') &&
        optionalStringField('logoUrl') &&
        optionalStringField('primaryColor') &&
        optionalStringField('joinCodePlayer') &&
        optionalStringField('joinCodeCoach');

      allow delete: if signedIn() && isHeadCoach(teamId);

      match /{subCollection}/{docId} {
        allow read: if signedIn() && hasMembership(teamId) && ['sessions', 'teamGoals', 'playerGoals', 'players', 'drills', 'assignments'].hasAny([subCollection]);
        allow create, update, delete: if signedIn() && coachCanManageTeam(teamId) && ['sessions', 'teamGoals', 'playerGoals', 'players', 'drills', 'assignments'].hasAny([subCollection]);
      }
    }

    /** Drills */
    match /drills/{drillId} {
      allow read: if signedIn() && resource.data.teamId is string && (hasMembership(resource.data.teamId) || coachCanManageTeam(resource.data.teamId));
      allow create: if signedIn() && coachCanManageTeam(request.resource.data.teamId) &&
        stringField('teamId') &&
        stringField('name') &&
        stringField('description') &&
        stringField('goalType') &&
        numberField('goalTargetValue') &&
        numberField('repsPerSet') &&
        numberField('sets') &&
        numberField('outs') &&
        stringField('countSituation') &&
        requiredStringList('targetZones') &&
        requiredStringList('pitchTypes') &&
        requiredStringList('baseRunners') &&
        optionalStringField('drillType') &&
        stringField('coachId');
      allow update, delete: if signedIn() && coachCanManageTeam(resource.data.teamId);
    }

    /** Assignments */
    match /assignments/{assignmentId} {
      allow read: if signedIn() && resource.data.teamId is string && (hasMembership(resource.data.teamId) || coachCanManageTeam(resource.data.teamId));
      allow create: if signedIn() && coachCanManageTeam(request.resource.data.teamId) &&
        stringField('teamId') &&
        stringField('drillId') &&
        requiredStringList('playerIds') &&
        boolField('isRecurring') &&
        stringField('assignedDate') &&
        optionalStringField('dueDate') &&
        stringListField('recurringDays') &&
        optionalStringField('coachId');
      allow update, delete: if signedIn() && coachCanManageTeam(resource.data.teamId);
    }

    /** Sessions */
    match /sessions/{sessionId} {
      allow read: if signedIn() && (
        request.auth.uid == resource.data.playerId ||
        (isCoach() && coachCanManageTeam(resource.data.teamId))
      );

      allow create: if signedIn() &&
        stringField('teamId') &&
        stringField('playerId') &&
        request.resource.data.playerId == request.auth.uid &&
        hasMembership(request.resource.data.teamId) &&
        stringField('name') &&
        stringField('date') &&
        listField('sets');

      allow update: if signedIn() && request.auth.uid == resource.data.playerId;
      allow delete: if signedIn() && request.auth.uid == resource.data.playerId;

      allow update: if signedIn() &&
        coachCanManageTeam(resource.data.teamId) &&
        request.resource.data.diff(resource.data).changedKeys().hasOnly(['coachFeedback']);
    }

    /** Personal goals */
    match /personalGoals/{goalId} {
      allow read: if signedIn() && (
        request.auth.uid == resource.data.playerId ||
        (isCoach() && coachCanManageTeam(resource.data.teamId))
      );

      allow create: if signedIn() &&
        stringField('playerId') &&
        stringField('teamId') &&
        stringField('metric') &&
        stringField('status') &&
        stringField('startDate') &&
        stringField('targetDate') &&
        numberField('targetValue') &&
        stringListField('targetZones') &&
        stringListField('pitchTypes') &&
        optionalStringField('drillType') &&
        optionalNumberField('minReps') &&
        optionalStringField('reflection') &&
        (
          request.resource.data.playerId == request.auth.uid ||
          (isCoach() && coachCanManageTeam(request.resource.data.teamId))
        );

      allow update, delete: if signedIn() && (
        request.auth.uid == resource.data.playerId ||
        (isCoach() && coachCanManageTeam(resource.data.teamId))
      );
    }

    /** Team goals */
    match /teamGoals/{goalId} {
      allow read: if signedIn() && resource.data.teamId is string && (hasMembership(resource.data.teamId) || coachCanManageTeam(resource.data.teamId));
      allow create: if signedIn() && coachCanManageTeam(request.resource.data.teamId) &&
        stringField('teamId') &&
        stringField('description') &&
        stringField('metric') &&
        stringField('status') &&
        stringField('startDate') &&
        stringField('targetDate') &&
        numberField('targetValue') &&
        stringListField('targetZones') &&
        stringListField('pitchTypes') &&
        optionalStringField('drillType');
      allow update, delete: if signedIn() && coachCanManageTeam(resource.data.teamId);
    }

    /** Join codes */
    match /joinCodes/{code} {
      allow read: if signedIn() && resource.data.teamId is string && coachCanManageTeam(resource.data.teamId);
      allow create: if signedIn() && coachCanManageTeam(request.resource.data.teamId) && stringField('teamId') && stringField('role');
      allow update, delete: if signedIn() && coachCanManageTeam(resource.data.teamId);
    }
  }
}
